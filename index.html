<!DOCTYPE html>
<html style="margin: 0px; height: 98%">
<head>
  <script src="https://unpkg.com/ag-grid-enterprise/dist/ag-grid-enterprise.min.noStyle.js"
          integrity="sha384-DEQdyWEjh/o0F7sUFf+iRK/5fpAaRagfs95IjczaKEivNFffajk6vjQSWn997IRP"
          crossorigin="anonymous"></script>
  <script type="text/javascript" charset="UTF-8" src="data.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
  <link rel="stylesheet" href="AGgrid.css">
</head>
<body style="margin: 10px; height: 100%">
  <div id="myGrid" class="ag-theme-alpine" style="height: 100%; width:100%;"></div>

  <script type="text/javascript" charset="utf-8">
    // get external data
    const data = data_;

    var hashValueGetter = function (params) {
      return params.node.rowIndex + 1;
    };

    var rowDrag = function (params) {
      // only rows that are NOT groups should be draggable
      return !params.node.group;
    };

    function pad(num, size) { return ('000000' + num).substr(-size); }

    // specify the columns
    const columnDefs = [
      { field: "#", width: 80, valueGetter: hashValueGetter, rowDrag: rowDrag },
      { field: "src", width: 400, cellClass: "cell-vertical-align-text-center", cellRenderer: "nodeRenderer" },
      { field: "prev", width: 110, cellClass: "cell-vertical-align-text-center", cellRenderer: "linkRenderer" },
      { field: "id", width: 400, cellClass: "cell-vertical-align-text-center", cellRenderer: "nodeRenderer", aggFunc: 'first' },
      { field: "next", width: 110, cellClass: "cell-vertical-align-text-center", cellRenderer: "linkRenderer" },
      { field: "dst", width: 400, cellClass: "cell-vertical-align-text-center", cellRenderer: "nodeRenderer" },
      { field: "seqs", width: 100, cellClass: "cell-vertical-align-text-center", cellRenderer: "seqRenderer" },
      { field: "unique", width: 100, cellClass: "cell-vertical-align-text-center", rowGroup: true, editable: true, aggFunc: 'first' },
    ];

    // // row grouping
    // const autoGroupColumnDef = {
    //   headerName: "Model",
    //   field: "model",
    //   cellRenderer:"agGroupCellRenderer",
    //   cellRendererParams: {
    //       checkbox: true
    //   }
    // }

    const blankCell = (params) => {
      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");
      
      imageElement.src = "imgs/blank_icon.png";
      imageElement.style.maxHeight = "50px";
      imageElement.style.maxWidth = "50px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const nodeRenderer = (params) => {
      var value = params.value
      if (value == false) { return blankCell(params); }
      else if (value == null) { return null; }
      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");
      const img_id = pad(value, 6)
      imageElement.src = "imgs/nodes/f" + img_id + "_node.png";
      imageElement.style.maxHeight = "216px";
      imageElement.style.maxWidth = "384px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      imageElement.addEventListener("click", function (e) {
        window.open("imgs/nodes/f" + img_id + "_full.png");
      });
      imageElement.title = "f" + img_id;
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const linkRenderer = (params) => {
      var value = params.value
      if (value == false) { return blankCell(params); }
      else if (value == null) { return null; }
      else if (typeof value === 'string') { return value; }
      
      const link = "f" + pad(value[0], 6) + "-f" + pad(value[1], 6);

      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");
      
      imageElement.src = "imgs/links/" + link + "_crop.png";
      imageElement.style.maxHeight = "50px";
      imageElement.style.maxWidth = "95px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      imageElement.addEventListener("click", function (e) {
        window.open("imgs/links/" + link + "_full.png");
      });
      imageElement.title = link;
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const seqRenderer = (params) => {
      if (params.value == null) { return null; }
      const resultElement = document.createElement("span");
      for (let i = 0; i < params.value.length; i++) {
        if (params.value[i].includes("_all")) { continue; }
        const imageElement = document.createElement("img");
        imageElement.src = "imgs/flow_icon.png";
        imageElement.style.height = "40px";
        imageElement.style.width = "40px";
        imageElement.addEventListener("click", function (e) {
          window.open(params.value[i] + ".html");
        });
        imageElement.title = params.value[i]
        resultElement.appendChild(imageElement);

        if (i != params.value.length - 1) {
          resultElement.appendChild(document.createElement("br"));
        }
      }
      return resultElement;
    };

    // let the grid know which columns and what data to use
    const gridOptions = {
      components: {
        nodeRenderer: nodeRenderer,
        linkRenderer: linkRenderer,
        seqRenderer: seqRenderer,
      },
      rowHeight: 250,
      rowData: data,
      // rowDragManaged: true,
      animateRows: true,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        wrapText: true,
      },
      columnDefs: columnDefs,
      rowGroupPanelShow: 'always',
      enableGroupEdit: true,
      suppressDragLeaveHidesColumns: true,
      suppressMakeColumnVisibleAfterUnGroup: true,
      onRowDragMove: onRowDragMove,
      // autoGroupColumnDef: autoGroupColumnDef,
      // groupSelectsChildren: true,
      // rowSelection: "multiple"
    };

    function onRowDragMove(event) {
      var movingNode = event.node;
      var overNode = event.overNode;

      // find out what unique group we are hovering over
      var groupUnique;
      if (overNode.group) {
        // if over a group, we take the group key (which will be the
        // unique as we are grouping by unique)
        groupUnique = overNode.key;
      } else {
        // if over a non-group, we take the unique directly
        groupUnique = overNode.data.unique;
      }

      var needToChangeParent = movingNode.unique !== groupUnique;

      if (needToChangeParent) {
        var movingData = movingNode.data;
        movingData.unique = groupUnique;
        gridOptions.api.applyTransaction({
          update: [movingData],
        });
        gridOptions.api.clearFocusedCell();
      }
    }

    // lookup the container we want the Grid to use
    const eGridDiv = document.querySelector("#myGrid");

    // create the grid passing in the div to use together with the columns & data we want to use
    new agGrid.Grid(eGridDiv, gridOptions);

    const getSelectedRows = () => {
      const selectedNodes = gridOptions.api.getSelectedNodes()
      const selectedData = selectedNodes.map( node => node.data )
      const selectedDataStringPresentation = selectedData.map( node => `${node.make} ${node.model}`).join(", ")
      alert(`Selected nodes: ${selectedDataStringPresentation}`);
    }

  </script>
</body>
</html>