<!DOCTYPE html>
<html lang="zh-Hant" style="margin: 0px; height: 98%">
<head>
  <title>AGgrid Viewer</title>
  <script src="https://unpkg.com/ag-grid-enterprise/dist/ag-grid-enterprise.min.noStyle.js"
          integrity="sha384-DEQdyWEjh/o0F7sUFf+iRK/5fpAaRagfs95IjczaKEivNFffajk6vjQSWn997IRP"
          crossorigin="anonymous"></script>
  <script type="text/javascript" charset="UTF-8" src="data.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
  <link rel="stylesheet" href="AGgrid.css">
</head>
<body style="margin: 10px; height: 100%">
  <div class="example-wrapper">
    <div style="margin-bottom: 5px;">
      <!-- <button onclick="expandFirstLevel()">ÂÖ®ÈÉ®Â±ïÈñã</button> -->
      <!-- <button onclick="collapseFirstLevel()">ÂÖ®ÈÉ®Êî∂Âêà</button> -->
      <!-- <button onclick="finishEdit()" style="float: right;">Á∑®ËºØÂÆåÊàê</button> -->
      <label class="switch">
        <input onclick="toggleMode()" type="checkbox" id="togBtn">
        <div class="slider round">
         <span class="on">ÂîØËÆÄÊ®°Âºè</span>
         <span class="off">Á∑®ËºØÊ®°Âºè</span>
        </div>
      </label>
    </div>
    <div id="myGrid" class="ag-theme-alpine">
    </div>
  </div>
  <div id="myGrid"></div>

  <script type="text/javascript" charset="utf-8">

    // ************* Edit/Read-Only Mode ************* //

    var editMode = true;
    var tempData = null;

    // ************* Data Preparation ************* //

    // get external data
    const idDict = {};
    idDict[-1] = { unique: "‚ùå", src: -1, prev: -1, dst: -1, next: -1 };
    data_.forEach(element => {
      idDict[element.id] = {
        unique: element.unique,
        src: element.src,
        prev: element.prev,
        dst: element.dst,
        next: element.next,
      };
      element["#"] = element.id;
    }); // idDict[id] = information dictionary

    function getNeighborNode(curId, n, front) {
      var target = curId;
      if (front) { for (let i = 0; i < n; i++) { target = idDict[target].dst; } }
      else { for (let i = 0; i < n; i++) { target = idDict[target].src; } };
      return target;
    }

    function getNeighborLink(curId, n, front) {
      var target = curId;
      if (front) { for (let i = 0; i < n; i++) { target = idDict[target].dst; } }
      else { for (let i = 0; i < n; i++) { target = idDict[target].src; } };
      if (front) { return idDict[target].prev; }
      else { return idDict[target].next; };
    }

    for (let i = 0; i < data_.length; i++) {
      var src_unique, dst_unique;
      data_[i].src_cur_dst = idDict[data_[i].src].unique + "," + data_[i].unique + "," + idDict[data_[i].dst].unique;
      for (let j = 2; j <= 5; j++) {
        data_[i]["src" + j] = getNeighborNode(data_[i].id, j, false);
        data_[i]["prev" + j] = getNeighborLink(data_[i].id, j, false);
        data_[i]["dst" + j] = getNeighborNode(data_[i].id, j, true);
        data_[i]["next" + j] = getNeighborLink(data_[i].id, j, true);
      }
    }
    const data = data_

    // ************* Tooltip Class ************* //

    const toolTipValueGetter = (params) => ({ value: params.value });

    class CustomTooltip {
      init(params) {
        const eGui = (this.eGui = document.createElement("div"));
        const value = params.value.value
        if (typeof value === "undefined" || value < 0) return;
        if (typeof value === "string" || value instanceof String) return;

        eGui.classList.add("custom-tooltip");
        const imageElement = document.createElement("img");
        if (value instanceof Array) {
          const link = "f" + pad(value[0], 6) + "-f" + pad(value[1], 6);
          imageElement.src = "imgs/links/" + link + "_full.png";
        }
        else {
          const img_id = pad(value, 6)
          imageElement.src = "imgs/nodes/f" + img_id + "_full.png";
        }
        imageElement.style.maxHeight = "540px";
        imageElement.style.maxWidth = "960px";
        imageElement.style.height = "auto";
        imageElement.style.width = "auto";
        eGui.appendChild(imageElement);
      }

      getGui() {
        return this.eGui;
      }
    }

    // ************* Column Definitions ************* //

    const columnDefs = [
      { headerName: "#", field: "#", width: 90, checkboxSelection: true, tooltipComponent: false },
      { headerName: "Flow", field: "seqs", width: 100, cellRenderer: "seqRenderer", editable: false, tooltipComponent: false },

      { headerName: "Ââç", groupId: "back", children: [
        { headerName: "Ââç‰∫îÁï´Èù¢", columnGroupShow: "open", field: "src5", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "prev5", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "ÂâçÂõõÁï´Èù¢", columnGroupShow: "open", field: "src4", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "prev4", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Ââç‰∏âÁï´Èù¢", columnGroupShow: "open", field: "src3", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "prev3", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Ââç‰∫åÁï´Èù¢", columnGroupShow: "open", field: "src2", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "prev2", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Ââç‰∏ÄÁï´Èù¢", field: "src", width: 270, cellRenderer: "nodeRenderer", aggFunc: "max" },
        { headerName: "ü°∫", field: "prev", width: 70, cellRenderer: "linkRenderer" },
      ]},

      { headerName: "Áï∂ÂâçÁï´Èù¢", field: "id", width: 270, cellRenderer: "nodeRenderer", aggFunc: "max", cellClass: "current", editable: false },

      { headerName: "Âæå", groupId: "front", children: [
        { headerName: "ü°∫", field: "next", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Âæå‰∏ÄÁï´Èù¢", field: "dst", width: 270, cellRenderer: "nodeRenderer", aggFunc: "max" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "next2", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Âæå‰∫åÁï´Èù¢", columnGroupShow: "open", field: "dst2", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "next3", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Âæå‰∏âÁï´Èù¢", columnGroupShow: "open", field: "dst3", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "next4", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "ÂæåÂõõÁï´Èù¢", columnGroupShow: "open", field: "dst4", width: 270, cellRenderer: "nodeRenderer" },
        { headerName: "ü°∫", columnGroupShow: "open", field: "next5", width: 70, cellRenderer: "linkRenderer" },
        { headerName: "Âæå‰∫îÁï´Èù¢", columnGroupShow: "open", field: "dst5", width: 270, cellRenderer: "nodeRenderer" },
      ]},

      { headerName: "È°ûÂà• (Áï∂ÂâçÁï´Èù¢)", field: "unique", hide: true, rowGroup: true, editable: false, cellRenderer: "uniqueRenderer" },
      { headerName: "È°ûÂà• (Ââç‰∏ÄÁï´Èù¢ü°∫Áï∂ÂâçÁï´Èù¢ü°∫Âæå‰∏ÄÁï´Èù¢)", field: "src_cur_dst", hide: true, rowGroup: true, cellRenderer: "uniqueRenderer", editable: false },

      { headerName: "ÊåâÈàï", width: 50, pinned: "right", cellRenderer: "actionRenderer", cellClass: "red" },
    ];

    // row grouping
    const autoGroupColumnDef = {
      width: 400,
      headerName: "È°ûÂà•",
      cellRenderer: "agGroupCellRenderer",
      cellClass: "left",
    }

    // ************* Cell Renderers ************* //

    const specialCell = (value) => {
      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");

      if (value == -1) imageElement.src = "imgs/blank_icon.png";
      else if (value == -2) imageElement.src = "imgs/trash_icon.png";
      imageElement.style.maxHeight = "30px";
      imageElement.style.maxWidth = "30px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const nodeRenderer = (params) => {
      var value = params.value
      if (value == "-2") { return specialCell(-2); }
      if (value == null) { return null; }
      if (value < 0) { return specialCell(value); }
      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");
      const img_id = pad(value, 6)
      imageElement.src = "imgs/nodes/f" + img_id + "_node.png";
      imageElement.style.maxHeight = "144px";
      imageElement.style.maxWidth = "256px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      imageElement.addEventListener("click", function (e) {
        window.open("imgs/nodes/f" + img_id + "_full.png");
      });
      imageElement.title = "f" + img_id;
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const linkRenderer = (params) => {
      var value = params.value
      if (value == "-2") { return specialCell(-2); }
      if (typeof value === "string") { return value; }
      if (value == null) { return null; }
      if (value < 0) { return specialCell(value); }

      const link = "f" + pad(value[0], 6) + "-f" + pad(value[1], 6);

      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");

      imageElement.src = "imgs/links/" + link + "_crop.png";
      imageElement.style.maxHeight = "15px";
      imageElement.style.maxWidth = "57px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      imageElement.addEventListener("click", function (e) {
        window.open("imgs/links/" + link + "_full.png");
      });
      imageElement.title = link;
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    const seqRenderer = (params) => {
      if (params.value == null || params.value == -1) { return null; }
      const resultElement = document.createElement("span");
      for (let i = 0; i < params.value.length; i++) {
        if (params.value[i].includes("_all")) { continue; }
        const imageElement = document.createElement("img");
        imageElement.src = "imgs/flow_icon.png";
        imageElement.style.height = "40px";
        imageElement.style.width = "40px";
        imageElement.addEventListener("click", function (e) {
          window.open(params.value[i] + ".html?" + pad(params.data.id, 6));
        });
        imageElement.title = params.value[i]
        resultElement.appendChild(imageElement);

        if (i != params.value.length - 1) {
          resultElement.appendChild(document.createElement("br"));
        }
      }
      return resultElement;
    };

    const uniqueRenderer = (params) => {
      if (params.value.includes(",")) {
        var src = params.value.split(",")[0]
        var cur = "<span style='color:green'>" + params.value.split(",")[1] + "</span>"
        var dst = params.value.split(",")[2]
        return [src, cur, dst].join(" ü°∫ ")
      }
      else {
        return "<b style='color:green'>" + params.value + "</b>"
      }
    };

    const actionRenderer = (params) => {
      const resultElement = document.createElement("span");
      const imageElement = document.createElement("img");

      imageElement.src = "imgs/trash_icon_white.png";
      imageElement.style.maxHeight = "30px";
      imageElement.style.maxWidth = "30px";
      imageElement.style.height = "auto";
      imageElement.style.width = "auto";
      imageElement.addEventListener("click", function (e) {
        const currentRow = params.node.data;
        params.api.applyTransaction({ remove: [currentRow] });
      });
      resultElement.appendChild(imageElement);
      return resultElement;
    };

    // ************* Grid Options ************* //

    const gridOptions = {
      components: {
        nodeRenderer: nodeRenderer,
        linkRenderer: linkRenderer,
        seqRenderer: seqRenderer,
        uniqueRenderer: uniqueRenderer,
        actionRenderer: actionRenderer,
        customTooltip: CustomTooltip,
      },
      rowHeight: 170,
      rowData: data,
      animateRows: true,
      defaultColDef: {
        suppressKeyboardEvent: clearSelected,
        editable: true,
        sortable: true,
        filter: true,
        resizable: true,
        wrapText: true,
        cellClass: "center",
        tooltipComponent: "customTooltip",
        tooltipValueGetter: toolTipValueGetter,
      },
      tooltipShowDelay: 500,
      columnDefs: columnDefs,
      rowGroupPanelShow: "always",
      enableGroupEdit: false,
      suppressDragLeaveHidesColumns: true,
      suppressMakeColumnVisibleAfterUnGroup: true,
      autoGroupColumnDef: autoGroupColumnDef,
      groupSelectsChildren: true,
      rowSelection: "multiple",
      suppressAggFuncInHeader: true,
      enableRangeSelection: true,
      suppressRowClickSelection: true,
      suppressClickEdit: true,
      undoRedoCellEditing: true,
      undoRedoCellEditingLimit: 50,
      tooltipMouseTrack: true,
    };

    // ************* Helper Functions ************* //

    function pad(num, size) { return ("000000" + num).substr(-size); }

    function getFirstNotDeleted(array) {
      if (!array.includes("-2") && !array.includes(-2)) return array[0];
      for (let i = 0; i < array.length; i++) {
        if (!(array[i] == "-2") && !(array[i] == -2)) return array[i];
      }
      return -1;
    }

    function clearSelected(params) {
      if (!params.editing) {
        let isBackspaceKey = params.event.keyCode === 8;
        let isDeleteKey = params.event.keyCode === 46;

        if (isBackspaceKey) { // Deletes entire rows
          const selectedRows = params.api.getSelectedRows();
          params.api.applyTransaction({ remove: selectedRows });
          return true;
        }

        if (isDeleteKey) { // Deletes selected cells
          params.api.getCellRanges().forEach(range => {
            let colIds = range.columns.map(col => col.colId);

            let startRowIndex = Math.min(
              range.startRow.rowIndex,
              range.endRow.rowIndex
            );
            let endRowIndex = Math.max(
              range.startRow.rowIndex,
              range.endRow.rowIndex
            );

            clearCells(startRowIndex, endRowIndex, colIds, params.api);
          });
          return true;
        }
      }
      return false;
    }

    function clearCells(start, end, columns, gridApi) {
      let itemsToUpdate = [];

      for (let i = start; i <= end; i++) {
        let data = gridApi.rowModel.rowsToDisplay[i].data;
        columns.forEach(column => {
          if (["#", "id", "seqs", "ag-Grid-AutoColumn"].includes(column)) return;
          if (data[column] == -1) return;
          gridApi.startEditingCell({rowIndex: i, colKey: column, charPress: "-2"});
          gridApi.stopEditing();
        });
      }
    }

    function autoSizeAll(skipHeader) {
      const allColumnIds = [];
      gridOptions.columnApi.getAllColumns().forEach((column) => {
        allColumnIds.push(column.colId);
      });
      console.log(gridOptions.columnApi.getRowGroupColumns())
      gridOptions.columnApi.autoSizeColumns(allColumnIds, skipHeader);
    }

    function expandFirstLevel() {
      gridOptions.api.forEachNode((node) => {
        if (node.level === 0) {
          node.setExpanded(true);
        }
      });
    }

    function collapseFirstLevel() {
      gridOptions.api.forEachNode((node) => {
        if (node.level === 0) {
          node.setExpanded(false);
        }
      });
    }

    function toggleMode() {
      const colsToHide = [
        "src2", "src3", "src4", "src5",
        "prev2", "prev3", "prev4", "prev5",
        "dst2", "dst3", "dst4", "dst5",
        "next2", "next3", "next4", "next5",
      ];

      if (!editMode) {
        gridOptions.api.setColumnDefs([]);
        gridOptions.api.setColumnDefs(columnDefs);
        editMode = true;
        gridOptions.api.setRowData(tempData);
      }

      else {
        // Save current data for later edit
        tempData = getAllRows();

        // Replace manually deleted links
        gridOptions.api.forEachNode((node, index) => {
          updateDeletedLinks(node, index);
        });

        // Update column definitions to read-only mode
        var colDefs = gridOptions.api.getColumnDefs();
        colDefs.forEach(function(colDef, index) {
          // console.log(colDef.headerName)
          if (colDef.children !== undefined) {
            for (let i = 0; i < colDef.children.length; i++) {
              if (colsToHide.includes(colDef.children[i].field)) colDef.children[i].hide = true;
              colDef.children[i].editable = false;
              colDef.children[i].suppressKeyboardEvent = false;
              colDef.children[i].checkboxSelection = false;
            }
          }
          else {
            colDef.editable = false;
            colDef.suppressKeyboardEvent = false;
            colDef.checkboxSelection = false;
          }
        });
        gridOptions.api.setColumnDefs(colDefs);

        // Export to CSV
        gridOptions.api.exportDataAsCsv({
          skipRowGroups: true,
          allColumns: true,
          skipColumnGroupHeaders: true,
          skipColumnHeaders: true,
          prependContent: "h,e,l,l,o,\n",
        });

        editMode = false;
      }
    }

    function updateDeletedLinks(node, index) {
      if (!node.group) {
        var srcs = [node.data.src, node.data.src2, node.data.src3, node.data.src4, node.data.src5];
        var prevs = [node.data.prev, node.data.prev2, node.data.prev3, node.data.prev4, node.data.prev5];
        var dsts = [node.data.dst, node.data.dst2, node.data.dst3, node.data.dst4, node.data.dst5];
        var nexts = [node.data.next, node.data.next2, node.data.next3, node.data.next4, node.data.next5];

        node.setDataValue("src", getFirstNotDeleted(srcs))
        node.setDataValue("prev", getFirstNotDeleted(prevs))
        node.setDataValue("dst", getFirstNotDeleted(dsts))
        node.setDataValue("next", getFirstNotDeleted(nexts))
      }
    }

    function getAllRows() {
      let rowData = [];
      gridOptions.api.forEachNode(node => rowData.push(node.data));
      rowData = rowData.filter(x => x !== undefined);
      return JSON.parse(JSON.stringify(rowData));
    }

    // ************* Initialization ************* //

    // lookup the container we want the Grid to use
    const eGridDiv = document.querySelector("#myGrid");

    // create the grid passing in the div to use together with the columns & data we want to use
    new agGrid.Grid(eGridDiv, gridOptions);

  </script>
</body>
</html>
